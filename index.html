<html>
	<head>
		<link rel="stylesheet" href="css/materialize.css">
		<link rel="stylesheet" href="css/marcotv.css">
		<script src="js/jquery-3.7.1.min.js"></script>
		<script src="js/materialize.js"></script>
	
	</head>

	<body>

  <!-- Modal Structure -->
  <div class="modal" id="choix-film-modal">
    <div class="modal-content">
      <h4>Vous avez choisi <span id="film-title"></span></h4>
	  <h5>Identifiez-vous</h5>
	  <button id="Pierre">Pierre</button>
	  <button id="Bernadette">Bernadette</button>
	  <p id="message-confirmation"></p>
    </div>
    <div class="modal-footer">
	  <input type="hidden" id="film-id"></input>
	  <input type="hidden" id="film-card"></input>
      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Fermer</a>
    </div>
  </div>
  
		<nav class="light-blue lighten-1" role="navigation">
			<div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">Logo</a>
				<ul class="right hide-on-med-and-down">
					<li><a href="#">Navbar Link</a></li>
				</ul>

				<ul id="nav-mobile" class="sidenav">
					<li><a href="#">Navbar Link</a></li>
				</ul>
				<a href="#" data-target="nav-mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
			</div>
		</nav>

		<div class="container">
			<div class="row" id="image-liste">
				<!-- Auto filled with javascript -->
			</div>
		</div>
		
	</body>
	
	<script>
	
    function activateModal() {
		$('.modal').modal();
		$("#Pierre").click(function() {
			var id = $("#film-id").attr("value");
			var card = $("#film-card").attr("value");
			$.ajax({
				url: "services/choose_movie.php?user=Pierre&movie=" + id,
				type: "GET",
				success: function(result){
					var resultat = JSON.parse(result);
					var message = "";
					if (resultat.code == "0") {
						console.log(result);
						var message = "Votre choix a été enregistré. Vous pouvez à présent mettre la carte " + card + " pour visionner votre film.";
					} else {
						console.log(result);
						var message = "Une erreur est survenue." + resultat.message;
					}
					$("#message-confirmation").html(message);
				}
			});
		});    
    }

	function activateClickFilm() {
		$(".image-container").click(function() {
			var id = $(this).attr("data-id");
			$("#film-id").attr("value", id);
			var card = $(this).attr("data-card");
			$("#film-card").attr("value", card);
			var title = $(this).attr("data-title");
			$("#film-title").html(title);
			$("#message-confirmation").html("");
			$('#choix-film-modal').modal('open');
		});
	}

    function fillCanvas() {
		$(".film-canvas").each(function() {
		    var x = $(this).attr("data-x");
		    var y = $(this).attr("data-y");
		    var poster = $(this).attr("data-poster");
		    var ctx = $(this).get(0).getContext("2d");
		    var width = $(this).parent().width();
		    var height = $(this).parent().width() * 433 / 316
            ctx.canvas.width = width;
            ctx.canvas.height = height;
		    var img = new Image;
            img.onload = function(){
                ctx.drawImage(img, x, y, 316, 433, 0, 0, width, height);
            };
            img.src = poster;
		});
    }

    function loadFilms() {
		$.ajax({
			url: "services/all_movies.php",
			type: "GET",
			success: function(result){
				var resultat = JSON.parse(result);
				if (resultat.code == "0") {
					console.log(result);

					var imageList = "";
					resultat.content.forEach(function (film) {
				        var dataDiv = "data-id='" + film.id + "' data-card='" + film.card + "' data-title='" + film.title + "'";
				        var dataCanvas = "data-poster='" + film.poster + "' data-x='" + film.posterx + "' data-y='" + film.postery + "'";
						imageList += "<div class='col s6 m6 l2 image-container' " + dataDiv + ">";
						imageList += "    <canvas class='film-canvas' width='100%' height='100%' " + dataCanvas + "></canvas>";
						imageList += "</div>";
					});
					
					$("#image-liste").html(imageList);
				} else {
					console.log("erreur: " + resultat.message);
				}
			},
			error: function(xhr, status, error) {
				console.log("erreur !!!");
			},
			complete: function() {
    			activateClickFilm();
    			fillCanvas();
			}
		});    
    }

	$(document).ready(function () {
		activateModal();
		loadFilms();
	});
	
	
	
	</script>
	
</html>
